[databases]
; ------------------------------------------------------------------------------
; One logical database entry. The start script will replace:
;   %HOST_IP%     - CRDB node hostname (e.g., us-east, us-central, us-west, or host IP)
;   %HOST_PORT%   - CRDB SQL port (usually 26257)
;   %DATABASE%    - database name (e.g., defaultdb)
;   %SERVER_USER% - we removed this so client credentials are passed through to the backend
;   %SIZE%        - max backend connections for this database, use this to limit the total pool size
;
; Example:
;   defaultdb = host=us-east port=26257 dbname=defaultdb user=pgb pool_size=64
; ------------------------------------------------------------------------------
%DATABASE% = host=%HOST_IP% port=%HOST_PORT% dbname=%DATABASE% pool_size=%SIZE%

[pgbouncer]
; ------------------------------------------------------------------------------
; Listener settings
; The start script will usually override listen_port via CLI and possibly write
; out per-instance config files (e.g., pgbouncer.0.ini, pgbouncer.1.ini)
; ------------------------------------------------------------------------------
listen_port = 5432
listen_addr = *

; ------------------------------------------------------------------------------
; Low level network settings
; ------------------------------------------------------------------------------
unix_socket_dir = %SCRIPT_DIR%/../run/%PGID%
so_reuseport = 1
pkt_buf = 8192
tcp_keepalive = 1
listen_backlog = 4096
server_round_robin = 1

; ------------------------------------------------------------------------------
; Authentication
;
; The start script should toggle one of these:
;   - auth_type = scram-sha-256  (for password auth from clients)
;   - auth_type = cert   (for TLS client-certificate auth)
;
; auth_file points to userlist.txt (also generated by start script).
; In password mode, it contains "user" "scram-hash" lines.
; In cert mode, you still list users, but passwords can be empty ("user" "").
; ------------------------------------------------------------------------------
auth_type = scram-sha-256
auth_file = %SCRIPT_DIR%/userlist.txt

; ------------------------------------------------------------------------------
; To use query-based auth (for Postgres), leave auth_query commented.
; For CockroachDB we typically use auth_file only.
; ------------------------------------------------------------------------------
; auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

; ------------------------------------------------------------------------------
; TLS for client <-> PgBouncer side
;
; In password mode, you can leave this disabled or use "require" for encryption.
; In cert mode, you typically use:
;   client_tls_sslmode = verify-full
;   client_tls_ca_file = /etc/pgbouncer/certs/ca.crt
;   client_tls_key_file = /etc/pgbouncer/certs/server.postgres.key
;   client_tls_cert_file = /etc/pgbouncer/certs/server.postgres.crt
;
; The start script will also toggle these based on mode.
; ------------------------------------------------------------------------------
client_tls_sslmode = disable
; client_tls_ca_file =
; client_tls_key_file =
; client_tls_cert_file =

; ------------------------------------------------------------------------------
; TLS for PgBouncer <-> backend
;
; In password mode, you can leave this "prefer" for encryption.
; In cert mode, you typically use:
;   server_tls_sslmode = verify-full
;   server_tls_ca_file = /etc/pgbouncer/certs/ca.crt
;   server_tls_key_file = /etc/pgbouncer/certs/client.pgb.key
;   server_tls_cert_file = /etc/pgbouncer/certs/client.pgb.crt
;
; The start script will also toggle these based on mode.
; ------------------------------------------------------------------------------
server_tls_sslmode = prefer
; server_tls_ca_file =
; server_tls_key_file =
; server_tls_cert_file =

; ------------------------------------------------------------------------------
; Pooling mode and performance settings
; ------------------------------------------------------------------------------
pool_mode = transaction
max_client_conn = 8192
default_pool_size = %SIZE%
max_db_connections = %SIZE%
max_user_connections = %SIZE%
min_pool_size = 10
reserve_pool_size = 10
reserve_pool_timeout = 10

; ------------------------------------------------------------------------------
; How long to wait for server connection
; ------------------------------------------------------------------------------
server_reset_query = DISCARD ALL
server_check_delay = 30

; disable these for txn load testing
query_wait_timeout = 0
query_timeout = 0
client_idle_timeout = 0
idle_transaction_timeout = 0

; TLS-related timeouts (if needed)
; server_login_retry = 15

; Connection sanity checks, timeouts
server_reset_query_always = 1
server_lifetime = 3600

; ------------------------------------------------------------------------------
; Logging
; ------------------------------------------------------------------------------
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
verbose = 0

; Where PgBouncer will log (stdout by default in Docker).
syslog = 0
logfile = %SCRIPT_DIR%/../pgbouncer.%PGID%.log
pidfile = %SCRIPT_DIR%/../pgbouncer.%PGID%.pid

; ------------------------------------------------------------------------------
; Admin console
; ------------------------------------------------------------------------------
admin_users = pgbouncer, %CLIENT%
stats_users = pgbouncer, %CLIENT%

; ------------------------------------------------------------------------------
; Misc
; ------------------------------------------------------------------------------
ignore_startup_parameters = extra_float_digits,options,autoReconnect,ApplicationName,reWriteBatchedInserts
