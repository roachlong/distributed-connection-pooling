#cloud-config
repo_update: true
package_update: true
package_upgrade: true
timezone: UTC

write_files:
  #
  # -----------------------------
  # PgBouncer runner + templates
  # -----------------------------
  #
  - path: /etc/pgbouncer/runner.env
    permissions: "0644"
    owner: root:root
    content: |
      PGB_CLIENT_ACCOUNT=appuser
      PGB_SERVER_ACCOUNT=appuser
      PGB_AUTH_MODE=password
      PGB_CLIENT_PASSWORD=appuser-password
      PGB_NUM_CONNECTIONS=24
      PGB_DATABASE=defaultdb

  - path: /etc/systemd/system/pgbouncer-runner.service
    permissions: "0644"
    owner: root:root
    content: |
      [Unit]
      Description=PgBouncer multi-instance runner
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=simple
      User=postgres
      Group=postgres

      # Controller-managed config
      EnvironmentFile=/etc/pgbouncer/runner.env

      ExecStart=/etc/pgbouncer/start-pgbouncer.sh \
        --client-account $${PGB_CLIENT_ACCOUNT} \
        --server-account $${PGB_SERVER_ACCOUNT} \
        --auth-mode $${PGB_AUTH_MODE} \
        --client-password $${PGB_CLIENT_PASSWORD} \
        --num-connections $${PGB_NUM_CONNECTIONS} \
        --database $${PGB_DATABASE} \
        --host-ip db.${region}.${dns_zone} \
        --host-port ${db_port}

      Restart=always
      RestartSec=5

      [Install]
      WantedBy=multi-user.target


  #
  # -----------------------------
  # HAProxy placeholders
  # (controller will overwrite)
  # -----------------------------
  #
  - path: /etc/haproxy/haproxy.cfg
    permissions: "0644"
    owner: root:root
    content: |
      global
        maxconn 200000
        log /dev/log local0

      defaults
        mode tcp
        log global
        option tcplog
        timeout connect 5s
        timeout client  180s
        timeout server  180s

      # Placeholder frontend (will be replaced by controller)
      frontend placeholder
        bind *:${pgb_port}
        default_backend placeholder

      backend placeholder
        server blackhole 127.0.0.1:9

  #
  # -----------------------------
  # Keepalived (VIP owner only)
  # -----------------------------
  #write_files:
  - path: /usr/local/bin/generate-keepalived-conf.sh
    permissions: "0755"
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      IFACE=$(ip -o -4 route show to 0/0 | awk '{print $5; exit}')

      cat > /etc/keepalived/keepalived.conf <<EOF
      vrrp_instance VI_DCP {
        state BACKUP
        interface $${IFACE}
        virtual_router_id 42
        priority 100
        advert_int 1

        authentication {
          auth_type PASS
          auth_pass dcpsecret
        }

        virtual_ipaddress {
          ${vip_private_ip}
        }

        # notify_master "/usr/local/bin/claim-eip.sh ${eip_allocation_id}"
      }
      EOF

packages:
  - awscli
  - ca-certificates
  - curl
  - dnsutils
  - gnupg2
  - haproxy
  - jq
  - keepalived
  - net-tools
  - pgbouncer
  - postgresql-client

runcmd:
  #
  # Base directories
  #
  - mkdir -p /etc/pgbouncer/certs
  - mkdir -p /var/run/pgbouncer
  - mkdir -p /var/log/pgbouncer
  - rm /etc/pgbouncer/pgbouncer.ini || true

  #
  # Fetch artifacts from GitHub (public)
  #
  - curl -fsSL https://raw.githubusercontent.com/roachlong/distributed-connection-pooling/refs/heads/main/terraform/aws/modules/dcp/files/start-pgbouncer.sh -o /etc/pgbouncer/start-pgbouncer.sh
  - curl -fsSL https://raw.githubusercontent.com/roachlong/distributed-connection-pooling/refs/heads/main/terraform/aws/modules/dcp/files/pgbouncer.template -o /etc/pgbouncer/pgbouncer.template
  - curl -fsSL https://raw.githubusercontent.com/roachlong/distributed-connection-pooling/refs/heads/main/terraform/aws/modules/dcp/files/claim-eip.sh -o /usr/local/bin/claim-eip.sh

  #
  # Permissions
  #
  - chmod +x /etc/pgbouncer/start-pgbouncer.sh
  - chmod +x /usr/local/bin/claim-eip.sh
  - chown -R postgres:postgres /etc/pgbouncer /var/run/pgbouncer /var/log/pgbouncer
  - chmod 700 /etc/pgbouncer/certs

  #
  # Enable services (configs pushed later)
  #
  - /usr/local/bin/generate-keepalived-conf.sh
  - systemctl daemon-reload
  - systemctl disable --now pgbouncer || true
  - systemctl enable pgbouncer-runner
  - systemctl enable haproxy
  - systemctl enable keepalived

  #
  # Start HA + VIP last
  #
  - systemctl start haproxy
  - systemctl start keepalived

users:
- default
- name: ${vm_user}
  gecos: Debian User
  sudo: ALL=(ALL) NOPASSWD:ALL
  shell: /bin/bash
  lock_passwd: true
  ssh_authorized_keys:
  - ${ssh_key}
- name: root
  lock_passwd: true
